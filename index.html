<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>MindTrackThings - Q&A from Your File</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.2.67/pdf.min.js"></script>
  <style>
    body {font-family:'Segoe UI',Arial,sans-serif;background:#f9fbfa;color:#333;max-width:540px;margin:2em auto;}
    .uploader {background:#fff;border-radius:1em;padding:2em 1em;box-shadow:0 8px 40px #aed0c918;text-align:center;}
    input[type=file], input[type=text] {margin:1em auto;}
    .answer-card {background:#fcfdff;border-radius:.7em;margin-top:.8em;padding:1.1em;}
    .what {margin-top:.55em;color:#1679a7;}
    .error {color:crimson;margin-top:1em;}
  </style>
</head>
<body>
  <div class="uploader">
    <h2>Upload PDF or Text File</h2>
    <input type="file" id="fileInput" accept=".pdf,.txt,.csv" />
    <br>
    <input type="text" id="question" placeholder="Ask your question (e.g., What is photosynthesis?)" style="width:80%;font-size:1em;padding:.5em"/>
    <button onclick="answerFromFile()">Explain Answer</button>
    <div id="result"></div>
    <div id="error" class="error"></div>
  </div>
  <script>
    let fileRawText = "";

    document.getElementById('fileInput').addEventListener('change', async function() {
      fileRawText = "";
      document.getElementById('result').innerHTML = "";
      document.getElementById('error').textContent = "";
      const file = this.files[0];
      if (!file) return;
      if(/\.(txt|csv)$/i.test(file.name)) {
        const reader = new FileReader();
        reader.onload = e => fileRawText = e.target.result || "";
        reader.readAsText(file);
      }
      else if(/\.pdf$/i.test(file.name)) {
        const reader = new FileReader();
        reader.onload = async function(e) {
          try {
            const typedarray = new Uint8Array(e.target.result);
            const pdf = await pdfjsLib.getDocument({data:typedarray}).promise;
            let textContent = '';
            for(let i=1; i<=pdf.numPages; ++i) {
              const page = await pdf.getPage(i);
              const txt = await page.getTextContent();
              textContent += txt.items.map(s => s.str).join(' ') + '\n';
            }
            fileRawText = textContent;
          } catch (err) {
            document.getElementById('error').textContent = "Failed to read PDF.";
          }
        };
        reader.readAsArrayBuffer(file);
      }
      else document.getElementById('error').textContent = "Only .txt, .csv or .pdf.";
    });

    function answerFromFile() {
      const question = document.getElementById('question').value.trim();
      const resultDiv = document.getElementById('result');
      document.getElementById('error').textContent = "";
      resultDiv.innerHTML = "";

      if (!fileRawText) {
        document.getElementById('error').textContent = "Upload a file first!";
        return;
      }
      if (!question) {
        document.getElementById('error').textContent = "Type a question.";
        return;
      }
      // Find best match in file's text
      let raw = fileRawText;
      let questionWords = question.toLowerCase().replace(/[^a-z0-9 ]/g,'').split(" ");
      let parts = raw.split(/[\r\n.?!]+/);
      let matches = [];
      for (let sent of parts) {
        // Simple intersection: if at least 2 question words appear in a sentence, consider as match!
        let hits = questionWords.filter(q=>sent.toLowerCase().includes(q));
        if (hits.length>=2 || (questionWords.length<=2 && hits.length>=1 ) ) matches.push(sent.trim());
      }
      if(matches.length==0) {
        resultDiv.innerHTML = `<div class="answer-card"><strong>No direct answer found.</strong><br>Try rephrasing your question, or check if your file contains the info.</div>`;
        return;
      }
      // Try to summarize the best matching result simply:
      let answer = matches[0];
      let explain = "";
      if(answer.length < 40 && matches[1]) answer += ". " + matches[1];
      // "Simple explanation": remove jargon, keep up to 180 chars, use common words
      if(answer.length > 180) {
        answer = answer.split(" ").slice(0,36).join(" ") + "...";
      }
      // Add a little more friendly explanation
      explain = `<div class="what"><strong>Simple Explanation:</strong><br>${answer}</div>`;
      resultDiv.innerHTML = `<div class="answer-card">${explain}</div>`;
    }
  </script>
</body>
</html>

